import{c as w}from"./database-BUiByx9r.js";const g="https://lxyexybnotixgpzflota.supabase.co",p="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4eWV4eWJub3RpeGdwemZsb3RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMDcwODIsImV4cCI6MjA3NTc4MzA4Mn0.TSbnvPKWiDdEFbyOh38qj_L87LZ75p3FiOW05hzEBlM",n=w(g,p,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!1}}),h={async createCardBatch(e){const{data:t,error:a}=await n.from("card_batches").insert(e).select().single();if(a)throw a;return t},async createCard(e){const{data:t,error:a}=await n.from("cards").insert(e).select().single();if(a)throw a;return t},async getCardByControlNumber(e,t){console.log("[Supabase] BULLETPROOF SEARCH for card:",e);const a=e.trim().toUpperCase();let{data:r,error:o}=await n.from("cards").select("*").eq("control_number",a).limit(10);if(!o&&(!r||r.length===0)){const i=await n.from("cards").select("*").ilike("control_number",`%${a}%`).limit(10);r=i.data,o=i.error}if(t&&r&&r.length>0&&(r=r.filter(i=>i.passcode===t)),console.log("[Supabase] BULLETPROOF Card search result:",{searchTerm:a,foundCards:r?.length||0,error:o,firstCard:r?.[0]?.control_number}),o)throw console.error("[Supabase] BULLETPROOF Card search error:",o),o;return r&&r.length>0?r[0]:null},async searchCards(e,t=10){const{data:a,error:r}=await n.rpc("search_card_universal",{search_term:e}).limit(t);if(r)throw r;return a},getPrimaryControlNumber(e){return e.unified_control_number||e.control_number_v2||e.control_number||`Card #${e.card_number}`},getDisplayCardNumber(e){return e.display_card_number||(e.card_number||0)+9999},async activateCard(e,t,a="16"){const{data:r}=await n.from("clinics").select("clinic_code").eq("id",t).single(),o=r?.clinic_code||null,{data:i,error:s}=await n.from("cards").update({is_activated:!0,status:"activated",assigned_clinic_id:t,activated_at:new Date().toISOString(),expires_at:new Date(Date.now()+365*24*60*60*1e3).toISOString(),location_code_v2:a,clinic_code_v2:o,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(s)throw s;return i},async claimPerk(e,t){const{data:a,error:r}=await n.from("card_perks").update({claimed:!0,claimed_at:new Date().toISOString(),claimed_by_clinic:t}).eq("id",e).eq("claimed",!1).select().single();if(r)throw r;return a},async createClinic(e){const{data:t,error:a}=await n.from("clinics").insert({...e,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(a)throw a;return t},async getClinicByCode(e){const{data:t,error:a}=await n.from("clinics").select("*").eq("clinic_code",e).single();if(a)throw a;return t},async getClinicCards(e){const{data:t,error:a}=await n.from("cards").select(`
        *,
        perks:card_perks(*)
      `).eq("assigned_clinic_id",e);if(a)throw a;return t},async logTransaction(e){const{data:t,error:a}=await n.from("card_transactions").insert({...e,created_at:new Date().toISOString()}).select().single();if(a)throw a;return t},async createAdminUser(e){const{data:t,error:a}=await n.from("mocards_admin_users").insert({...e,created_at:new Date().toISOString()}).select().single();if(a)throw a;return t},async getAdminByUsername(e){const{data:t,error:a}=await n.from("mocards_admin_users").select("*").eq("username",e).single();if(a)throw a;return t},async createAppointment(e){const{data:t,error:a}=await n.from("appointments").insert({...e,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(a)throw a;return t},async getAppointments(e){let t=n.from("appointments").select(`
        *,
        clinic:clinics(*),
        card:cards(*)
      `).order("created_at",{ascending:!1});e?.status&&(t=t.eq("status",e.status)),e?.clinic_id&&(t=t.eq("assigned_clinic_id",e.clinic_id)),e?.admin_id&&(t=t.eq("booked_by_admin_id",e.admin_id)),e?.date_from&&(t=t.gte("appointment_date",e.date_from)),e?.date_to&&(t=t.lte("appointment_date",e.date_to));const{data:a,error:r}=await t;if(r)throw r;return a},async getAppointmentById(e){const{data:t,error:a}=await n.from("appointments").select(`
        *,
        clinic:clinics(*),
        card:cards(*)
      `).eq("id",e).single();if(a)throw a;return t},async updateAppointmentStatus(e,t,a,r,o){const{data:i,error:s}=await n.rpc("update_appointment_status",{p_appointment_id:e,p_new_status:t,p_changed_by:a,p_changed_by_id:r,p_reason:o});if(s)throw s;return i},async rescheduleAppointment(e,t,a,r,o,i){const{data:s,error:d}=await n.rpc("reschedule_appointment",{p_appointment_id:e,p_new_date:t,p_new_time:a,p_reschedule_reason:r,p_changed_by:o,p_changed_by_id:i});if(d)throw d;return s},async getAppointmentHistory(e){const{data:t,error:a}=await n.from("appointment_status_history").select("*").eq("appointment_id",e).order("created_at",{ascending:!0});if(a)throw a;return t},async createAppointmentNotification(e){const{data:t,error:a}=await n.from("appointment_notifications").insert({...e,created_at:new Date().toISOString()}).select().single();if(a)throw a;return t},async getUnreadNotifications(e,t){let a=n.from("appointment_notifications").select("*").eq("recipient_type",e).is("read_at",null).order("created_at",{ascending:!1});t&&(a=a.eq("recipient_id",t));const{data:r,error:o}=await a;if(o)throw o;return r},async markNotificationAsRead(e){const{data:t,error:a}=await n.from("appointment_notifications").update({read_at:new Date().toISOString()}).eq("id",e).select().single();if(a)throw a;return t},async getAllClinics(){const{data:e,error:t}=await n.from("clinics").select("*").eq("status","active").order("name");if(t)throw t;return e},async createPerkdatalate(e){const{data:t,error:a}=await n.from("perk_datalates").insert({...e,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(a)throw a;return t},async getAllPerkdatalates(){const{data:e,error:t}=await n.from("perk_datalates").select("*").order("category",{ascending:!0}).order("name",{ascending:!0});if(t)throw t;return e},async getActivePerkdatalates(){const{data:e,error:t}=await n.from("perk_datalates").select("*").eq("is_active",!0).order("category",{ascending:!0}).order("name",{ascending:!0});if(t)throw t;return e},async getPerkdatalateById(e){const{data:t,error:a}=await n.from("perk_datalates").select("*").eq("id",e).single();if(a)throw a;return t},async updatePerkdatalate(e,t){const{data:a,error:r}=await n.from("perk_datalates").update({...t,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(r)throw r;return a},async deletePerkdatalate(e){if((await this.getPerkdatalateById(e)).is_system_default)throw new Error("System default perks cannot be deleted");const{data:a,error:r}=await n.from("perk_datalates").delete().eq("id",e).eq("is_system_default",!1).select().single();if(r)throw r;return a},async getAllPerkCategories(){const{data:e,error:t}=await n.from("perk_categories").select("*").order("display_order",{ascending:!0});if(t)throw t;return e},async createPerkCategory(e){const{data:t,error:a}=await n.from("perk_categories").insert({...e,created_at:new Date().toISOString()}).select().single();if(a)throw a;return t},async updatePerkCategory(e,t){const{data:a,error:r}=await n.from("perk_categories").update(t).eq("id",e).select().single();if(r)throw r;return a},async getClinicPerkCustomizations(e){const{data:t,error:a}=await n.from("clinic_perk_customizations").select(`
        *,
        perk_datalate:perk_datalates(*)
      `).eq("clinic_id",e).order("created_at",{ascending:!1});if(a)throw a;return t},async getActiveClinicPerkCustomizations(e){const{data:t,error:a}=await n.from("clinic_perk_customizations").select(`
        *,
        perk_datalate:perk_datalates(*)
      `).eq("clinic_id",e).eq("is_enabled",!0).order("created_at",{ascending:!1});if(a)throw a;return t},async updateClinicPerkCustomization(e,t){const{data:a,error:r}=await n.from("clinic_perk_customizations").update({...t,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(r)throw r;return a},async createClinicPerkCustomization(e){const{data:t,error:a}=await n.from("clinic_perk_customizations").insert({...e,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(a)throw a;return t},async recordPerkUsage(e){const t=new Date(e.redemption_date),a=`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}`,{data:r,error:o}=await n.from("perk_usage_analytics").insert({...e,month_year:a,created_at:new Date().toISOString()}).select().single();if(o)throw o;return r},async getClinicPerkAnalytics(e,t){let a=n.from("perk_usage_analytics").select("*").eq("clinic_id",e);t&&(a=a.eq("month_year",t));const{data:r,error:o}=await a.order("redemption_date",{ascending:!1});if(o)throw o;return r},async getPerkdatalateUsageStats(e,t){let a=n.from("perk_usage_analytics").select("*").eq("perk_datalate_id",e);t&&(a=a.eq("month_year",t));const{data:r,error:o}=await a;if(o)throw o;return r},async getCodeGenerationSettings(){const{data:e,error:t}=await n.from("code_generation_settings").select("*").order("setting_type",{ascending:!0}).order("generation_mode",{ascending:!0});if(t)throw t;return e},async updateCodeGenerationSetting(e,t){const{data:a,error:r}=await n.from("code_generation_settings").update({...t,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(r)throw r;return a},async createCodeGenerationSetting(e){const{data:t,error:a}=await n.from("code_generation_settings").insert({...e,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(a)throw a;return t},async getLocationCodes(){const{data:e,error:t}=await n.from("location_codes").select("*").eq("is_active",!0).order("sort_order",{ascending:!0});if(t)throw t;return e},async getAllLocationCodes(){const{data:e,error:t}=await n.from("location_codes").select("*").order("sort_order",{ascending:!0});if(t)throw t;return e},async createLocationCode(e){const{data:t,error:a}=await n.from("location_codes").insert({...e,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(a)throw a;return t},async updateLocationCode(e,t){const{data:a,error:r}=await n.from("location_codes").update({...t,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(r)throw r;return a},async generateBatchNumber(e,t,a){const{data:r,error:o}=await n.rpc("generate_batch_number",{generation_mode:e,custom_input:t,location_prefix:a||"PHL"});if(o)throw o;return r},async generateControlNumber(e,t,a="auto",r){const{data:o,error:i}=await n.rpc("generate_control_number",{batch_prefix:e,card_index:t,generation_mode:a,custom_format:r});if(i)throw i;return o},async generatePasscode(e,t="auto",a){const{data:r,error:o}=await n.rpc("generate_passcode",{location_code:e,generation_mode:t,custom_passcode:a});if(o)throw o;return r},async normalizeCode(e,t){const{data:a,error:r}=await n.rpc("normalize_code",{input_code:e,code_type:t});if(r)throw r;return a},async getCardByControlNumberNormalized(e,t){const a=await this.normalizeCode(e,"control"),r=t?await this.normalizeCode(t,"passcode"):void 0;return this.getCardByControlNumber(a,r)},async getCardCodeHistory(e){const{data:t,error:a}=await n.from("card_code_history").select("*").eq("card_id",e).order("created_at",{ascending:!1});if(a)throw a;return t},async recordCardCodeChange(e,t,a,r,o,i,s){const{data:d,error:c}=await n.from("card_code_history").insert({card_id:e,change_type:t,field_name:a,old_value:r,new_value:o,changed_by:i,change_reason:s,metadata:{},created_at:new Date().toISOString()}).select().single();if(c)throw c;return d},async getSystemVersions(){const{data:e,error:t}=await n.from("system_versions").select("*").order("component",{ascending:!0});if(t)throw t;return e},async getComponentVersion(e){const{data:t,error:a}=await n.from("system_versions").select("*").eq("component",e).single();if(a)throw a;return t},async saveUserSessionState(e,t,a,r,o){const{data:i,error:s}=await n.from("user_session_state").upsert({user_id:e,user_type:t,component_name:a,form_data:r,draft_state:o,last_saved:new Date().toISOString(),expires_at:new Date(Date.now()+864e5).toISOString()}).select().single();if(s)throw s;return i},async getUserSessionState(e,t){const{data:a,error:r}=await n.from("user_session_state").select("*").eq("user_id",e).eq("component_name",t).single();if(r&&r.code!=="PGRST116")throw r;return a},async clearExpiredSessions(){const{error:e}=await n.from("user_session_state").delete().lt("expires_at",new Date().toISOString());if(e)throw e},async updateCardCodes(e,t,a){const r=await n.from("cards").select("control_number, passcode, location_code").eq("id",e).single();if(r.error)throw r.error;const{data:o,error:i}=await n.from("cards").update({...t,admin_override:!0,last_modified_by:a,last_modified_at:new Date().toISOString()}).eq("id",e).select().single();if(i)throw i;for(const[s,d]of Object.entries(t))if(s in r.data&&d!==void 0){const c=r.data[s];c!==d&&await this.recordCardCodeChange(e,s.includes("control")?"control_updated":s.includes("passcode")?"passcode_updated":"batch_updated",s,c,d,a,"Admin manual update")}return o},async getCardBatchById(e){const{data:t,error:a}=await n.from("card_batches").select("*").eq("id",e).single();if(a)throw a;return t},async generateCardsWithSettings(e,t,a,r){const o=[],i=await this.getCardBatchById(e);for(let c=0;c<t;c++){const l=(a.startIndex||1)+c,_=await this.generateControlNumber(i.batch_number,l,a.generationMode,a.customPrefix?`${a.customPrefix}-${l.toString().padStart(3,"0")}`:void 0),u=await this.generatePasscode(a.locationCode,a.generationMode),m={batch_id:e,control_number:_,passcode:u,location_code:a.locationCode,status:"unactivated",generation_method:a.generationMode,admin_override:a.generationMode!=="auto",last_modified_by:r,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};o.push(m)}const{data:s,error:d}=await n.from("cards").insert(o).select();if(d)throw d;for(const c of s)await this.recordCardCodeChange(c.id,"created","card_created","",`Control: ${c.control_number}, Passcode: ${c.passcode}`,r,`Batch generation with ${a.generationMode} mode`);return s},async getAllCardBatches(){const{data:e,error:t}=await n.from("card_batches").select("*").order("created_at",{ascending:!1});if(t)throw t;return e}};export{h as d,n as s};
