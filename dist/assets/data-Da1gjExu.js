import{r as m}from"./charts-sad3owxz.js";import{u as y,t as h,a as A,f as n,e as f,D as k}from"./index-gXUEvZpV.js";const T=(t={})=>{const{enabled:e=!0,checkInterval:a=3e4,showNotifications:r=!0}=t,{addToast:s}=y(),o=m.useRef(null),l=m.useRef(!1),d=async()=>{try{{const u=await(await fetch("/index.html",{cache:"no-cache",headers:{"Cache-Control":"no-cache"}})).text(),i=u.match(/<script[^>]*src="[^"]*assets[^"]*\.js"[^>]*>/),w=u.match(/<meta name="version" content="([^"]*)">/);return w?w[1]:i?i[0]:null}}catch(c){return console.warn("Failed to check for app updates:",c),null}},p=async()=>{if(!(l.current||!e)){l.current=!0;try{const c=await d();if(c&&o.current){if(c!==o.current){r&&s(h("App Updated","A new version is available. The page will refresh automatically.")),setTimeout(()=>{window.location.reload()},2e3);return}}else c&&!o.current&&(o.current=c)}catch(c){console.warn("Update check failed:",c)}finally{l.current=!1}}};return m.useEffect(()=>{if(!e)return;d().then(w=>{o.current=w});const c=setInterval(p,a),u=()=>{document.hidden||setTimeout(p,1e3)};document.addEventListener("visibilitychange",u);const i=()=>{setTimeout(p,1e3)};return window.addEventListener("online",i),()=>{clearInterval(c),document.removeEventListener("visibilitychange",u),window.removeEventListener("online",i)}},[e,a,r]),{forceRefresh:()=>{r&&s(A("Refreshing","Updating to the latest version...")),setTimeout(()=>{window.location.reload()},500)},checkForUpdates:p}},C=(t,e,a)=>`MOC-${t.toString().padStart(5,"0")}-${e}-${a}`,B=async t=>{const a=(await n.clinics.getAll()).map(s=>s.code);let r=1;if(t==="Custom"||t==="Others"){for(;a.includes(`CVT${r.toString().padStart(3,"0")}`);)r++;return`CVT${r.toString().padStart(3,"0")}`}return t},I={getAll:async()=>await n.cards.getAll(),getByControlNumber:async t=>(await n.cards.getAll()).find(a=>a.controlNumber===t)||null,getByClinicId:async t=>(await n.cards.getAll()).filter(a=>a.clinicId===t),create:async t=>{try{return await n.cards.add(t)}catch(e){throw console.error("Failed to create card:",e),e}},createBatch:async(t,e,a,r,s=5)=>{const o=[],l=[];console.log("[BATCH] Creating batch cards from",t,"to",e);const d=await n.cards.getAll(),p=new Set(d.map(g=>g.controlNumber));for(let g=t;g<=e;g++){const c=C(g,a,r);if(p.has(c)){console.log("[BATCH] Skipping existing card:",c),l.push(c);continue}const u={controlNumber:c,fullName:"",status:"inactive",perksTotal:s,perksUsed:0,clinicId:"",expiryDate:"2025-12-31"};console.log("[BATCH] Creating card:",u.controlNumber);try{const i=await n.cards.add(u);o.push(i),console.log("[BATCH] Card created successfully:",i.controlNumber)}catch(i){throw console.error("[BATCH] Failed to create card:",u.controlNumber,i),new Error(`Failed to create card ${u.controlNumber}: ${i instanceof Error?i.message:"Unknown error"}`)}}return console.log("[BATCH] Successfully created",o.length,"cards"),l.length>0&&console.log("[BATCH] Skipped",l.length,"existing cards:",l),o},updateStatus:async(t,e)=>{const r=(await n.cards.getAll()).find(s=>s.controlNumber===t);return r?(await n.cards.update(r.id,{status:e}),!0):!1},assignToClinic:async(t,e)=>{const a=await n.clinics.getAll(),r=await n.cards.getAll(),s=a.find(d=>d.id===e);if(!s)return!1;const o=r.filter(d=>d.clinicId===e).length,l=f[s.plan];return o+t.length>l?!1:(await Promise.all(t.map(async d=>{const p=r.find(g=>g.controlNumber===d);p&&await n.cards.update(p.id,{clinicId:e})})),!0)},updatePerks:async(t,e)=>{const r=(await n.cards.getAll()).find(s=>s.controlNumber===t);if(r){const s=Math.min(e,r.perksTotal);return await n.cards.update(r.id,{perksUsed:s}),!0}return!1},delete:async t=>{const a=(await n.cards.getAll()).find(r=>r.controlNumber===t);return a?(await n.cards.remove(a.id),!0):!1}},S={getAll:async()=>await n.perks.getAll(),getById:async t=>(await n.perks.getAll()).find(a=>a.id===t)||null,getByType:async t=>(await n.perks.getAll()).filter(a=>a.type===t),getActive:async()=>(await n.perks.getAll()).filter(e=>e.isActive),create:async t=>{const e={...t,id:`perk_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return await n.perks.add(e),e},update:async(t,e)=>{if((await n.perks.getAll()).find(s=>s.id===t)){const s={...e,updatedAt:new Date().toISOString()};return await n.perks.update(t,s),!0}return!1},delete:async t=>(await n.perks.remove(t),!0),initializeDefaults:async()=>{(await n.perks.getAll()).length===0&&await Promise.all(k.map(async e=>{await S.create(e)}))}},N={getAll:async()=>await n.clinics.getAll(),getById:async t=>(await n.clinics.getAll()).find(a=>a.id===t)||null,getByCode:async t=>(await n.clinics.getAll()).find(a=>a.code===t)||null,authenticate:async(t,e)=>(await n.clinics.getAll()).find(r=>r.username===t&&r.password===e)||null,create:async t=>{const e={...t,id:`clinic_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,subscriptionStatus:"active",subscriptionStartDate:new Date().toISOString(),maxCards:f[t.plan],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),isActive:!0};return await n.clinics.add(e),e},update:async(t,e)=>(await n.clinics.getAll()).find(s=>s.id===t)?(await n.clinics.update(t,e),!0):!1,delete:async t=>(await n.clinics.remove(t),!0),getAssignedCardsCount:async t=>(await n.cards.getAll()).filter(a=>a.clinicId===t).length,getPlanLimit:async t=>{const a=(await n.clinics.getAll()).find(r=>r.id===t);return a?f[a.plan]:0}},O={getAll:async()=>await n.appointments.getAll(),getByClinicId:async t=>(await n.appointments.getAll()).filter(a=>a.clinicId===t),create:async t=>{const e={...t,id:`appointment_${Date.now()}_${Math.random().toString(36).substr(2,9)}`};return await n.appointments.add(e),e},updateStatus:async(t,e)=>(await n.appointments.getAll()).find(s=>s.id===t)?(await n.appointments.update(t,{status:e}),!0):!1},D={getAll:async()=>await n.perkRedemptions.getAll(),getByCardNumber:async t=>(await n.perkRedemptions.getAll()).filter(a=>a.cardControlNumber===t),getByClinicId:async t=>(await n.perkRedemptions.getAll()).filter(a=>a.clinicId===t),create:async t=>await n.perkRedemptions.add(t),getByPerkType:async(t,e)=>(await n.perkRedemptions.getAll()).filter(r=>r.cardControlNumber===t&&r.perkName.toLowerCase().includes(e.toLowerCase()))};export{O as a,I as b,N as c,S as d,B as e,C as g,D as p,T as u};
